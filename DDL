--------------------------------------------------------------------------------
-- DDL for the Advanced BRM Tool (Parts 1â€“4)
-- No references to external code. All columns match usage in the code.
--------------------------------------------------------------------------------

-- 1) USERS
CREATE TABLE USERS (
    USER_ID INT IDENTITY(1,1) PRIMARY KEY,
    USERNAME VARCHAR(100) NOT NULL,
    PASSWORD VARCHAR(200) NOT NULL,
    USER_GROUP VARCHAR(50) NOT NULL,
    CREATED_TIMESTAMP DATETIME DEFAULT GETDATE()
);

-- 2) BUSINESS_GROUPS
CREATE TABLE BUSINESS_GROUPS (
    GROUP_NAME VARCHAR(100) NOT NULL PRIMARY KEY,
    DESCRIPTION VARCHAR(500) NULL,
    EMAIL VARCHAR(200) NULL
);

-- 3) GROUP_PERMISSIONS
CREATE TABLE GROUP_PERMISSIONS (
    PERM_ID INT IDENTITY(1,1) PRIMARY KEY,
    GROUP_NAME VARCHAR(100) NOT NULL,
    TARGET_TABLE VARCHAR(200) NOT NULL
);

-- 4) BUSINESS_GROUP_APPROVERS
CREATE TABLE BUSINESS_GROUP_APPROVERS (
    APPROVER_ID INT IDENTITY(1,1) PRIMARY KEY,
    GROUP_NAME VARCHAR(100) NOT NULL,
    USERNAME VARCHAR(100) NOT NULL
);

-- 5) BRM_RULE_GROUPS
CREATE TABLE BRM_RULE_GROUPS (
    GROUP_ID INT IDENTITY(1,1) PRIMARY KEY,
    GROUP_NAME VARCHAR(100) NOT NULL
);

-- 6) BRM_RULES
CREATE TABLE BRM_RULES (
    RULE_ID INT IDENTITY(1,1) PRIMARY KEY,
    GROUP_ID INT NULL,
    PARENT_RULE_ID INT NULL,
    RULE_TYPE_ID INT NULL,  -- if needed
    RULE_NAME VARCHAR(200) NOT NULL,
    RULE_SQL VARCHAR(MAX) NULL,
    EFFECTIVE_START_DATE DATETIME NULL,
    EFFECTIVE_END_DATE DATETIME NULL,
    STATUS VARCHAR(50) NOT NULL DEFAULT 'INACTIVE',
    VERSION INT NOT NULL DEFAULT 1,
    CREATED_BY VARCHAR(100) NULL,
    DESCRIPTION VARCHAR(MAX) NULL,
    OPERATION_TYPE VARCHAR(50) NULL,
    BUSINESS_JUSTIFICATION VARCHAR(MAX) NULL,
    CREATED_TIMESTAMP DATETIME DEFAULT GETDATE(),
    UPDATED_BY VARCHAR(100) NULL,
    OWNER_GROUP VARCHAR(100) NULL,
    CLUSTER_NAME VARCHAR(100) NULL,
    APPROVAL_STATUS VARCHAR(50) NULL,
    IS_GLOBAL BIT NOT NULL DEFAULT 0,
    CRITICAL_RULE BIT NOT NULL DEFAULT 0,
    CRITICAL_SCOPE VARCHAR(50) NULL,
    CDC_TYPE VARCHAR(50) NULL,
    LIFECYCLE_STATE VARCHAR(50) NOT NULL DEFAULT 'DRAFT',
    LOCK_STATUS VARCHAR(50) NULL,  -- e.g. "LOCKED" or "UNLOCKED"
    LOCKED_BY VARCHAR(100) NULL,
    LOCKED_AT DATETIME NULL,
    ENCRYPTED_FILE_PATH VARCHAR(500) NULL
);

-- 7) BRM_RULE_LOCKS
CREATE TABLE BRM_RULE_LOCKS (
    LOCK_ID INT IDENTITY(1,1) PRIMARY KEY,
    RULE_ID INT NOT NULL,
    LOCKED_BY VARCHAR(100) NOT NULL,
    LOCK_TIMESTAMP DATETIME NOT NULL,
    EXPIRY_TIMESTAMP DATETIME NULL,
    FORCE_LOCK BIT NOT NULL DEFAULT 0,
    ACTIVE_LOCK BIT NOT NULL DEFAULT 1
);

-- 8) BRM_RULE_TABLE_DEPENDENCIES
CREATE TABLE BRM_RULE_TABLE_DEPENDENCIES (
    DEPENDENCY_ID INT IDENTITY(1,1) PRIMARY KEY,
    RULE_ID INT NOT NULL,
    DATABASE_NAME VARCHAR(100) NOT NULL,
    TABLE_NAME VARCHAR(200) NOT NULL,
    COLUMN_NAME VARCHAR(200) NULL,
    COLUMN_OP VARCHAR(50) NULL
);

-- 9) BRM_AUDIT_LOG
CREATE TABLE BRM_AUDIT_LOG (
    AUDIT_ID INT IDENTITY(1,1) PRIMARY KEY,
    ACTION VARCHAR(50) NOT NULL,
    TABLE_NAME VARCHAR(100) NOT NULL,
    RECORD_ID VARCHAR(100) NULL,
    ACTION_BY VARCHAR(100) NOT NULL,
    OLD_DATA VARCHAR(MAX) NULL,
    NEW_DATA VARCHAR(MAX) NULL,
    ACTION_TIMESTAMP DATETIME NOT NULL DEFAULT GETDATE()
);

-- 10) BRM_DEFECT_LOGS
CREATE TABLE BRM_DEFECT_LOGS (
    DEFECT_ID INT IDENTITY(1,1) PRIMARY KEY,
    RULE_ID INT NULL,
    DESCRIPTION VARCHAR(MAX) NOT NULL,
    SEVERITY VARCHAR(20) NOT NULL,
    REPORTER VARCHAR(100) NOT NULL,
    STATUS VARCHAR(50) NOT NULL DEFAULT 'Open',
    RESOLUTION VARCHAR(MAX) NULL,
    TIMESTAMP DATETIME DEFAULT GETDATE()
);

-- 11) BRM_RULE_APPROVALS
CREATE TABLE BRM_RULE_APPROVALS (
    APPROVAL_ID INT IDENTITY(1,1) PRIMARY KEY,
    RULE_ID INT NOT NULL,
    GROUP_NAME VARCHAR(100) NOT NULL,
    USERNAME VARCHAR(100) NOT NULL,
    APPROVED_FLAG INT NOT NULL DEFAULT 0,  -- 0 => pending, 1 => approved, 2 => rejected
    APPROVED_TIMESTAMP DATETIME NULL,
    APPROVAL_STAGE INT NOT NULL DEFAULT 1
);

-- 12) BRM_GLOBAL_CRITICAL_LINKS
CREATE TABLE BRM_GLOBAL_CRITICAL_LINKS (
    LINK_ID INT IDENTITY(1,1) PRIMARY KEY,
    GCR_RULE_ID INT NOT NULL,
    TARGET_RULE_ID INT NOT NULL
);

-- 13) RULE_SCHEDULES
CREATE TABLE RULE_SCHEDULES (
    SCHEDULE_ID INT IDENTITY(1,1) PRIMARY KEY,
    RULE_ID INT NOT NULL,
    SCHEDULE_TIME DATETIME NOT NULL,
    STATUS VARCHAR(50) NOT NULL DEFAULT 'Scheduled', -- e.g. 'Scheduled','Executed','Failed'
    CREATED_TIMESTAMP DATETIME NOT NULL DEFAULT GETDATE(),
    VALIDATION_FLAG BIT NOT NULL DEFAULT 0
);

-- 14) RULE_EXECUTION_LOGS
CREATE TABLE RULE_EXECUTION_LOGS (
    LOG_ID INT IDENTITY(1,1) PRIMARY KEY,
    RULE_ID INT NOT NULL,
    EXECUTION_TIMESTAMP DATETIME NOT NULL,
    PASS_FLAG BIT NOT NULL DEFAULT 1,
    MESSAGE VARCHAR(500) NULL,
    RECORD_COUNT INT NOT NULL DEFAULT 0,
    EXECUTION_TIME_MS INT NOT NULL DEFAULT 0
);

-- 15) COMPOSITE_RULES
CREATE TABLE COMPOSITE_RULES (
    COMPOSITE_RULE_ID INT IDENTITY(1,1) PRIMARY KEY,
    CRULE_NAME VARCHAR(200) NOT NULL,
    LOGIC_EXPR VARCHAR(MAX) NULL,
    ACTION_ON_PASS VARCHAR(200) NULL
);

-- 16) RULE_CONFLICTS
CREATE TABLE RULE_CONFLICTS (
    CONFLICT_ID INT IDENTITY(1,1) PRIMARY KEY,
    RULE_ID1 INT NOT NULL,
    RULE_ID2 INT NOT NULL,
    PRIORITY INT NOT NULL DEFAULT 0
);

-- 17) DECISION_TABLES
CREATE TABLE DECISION_TABLES (
    DECISION_TABLE_ID INT IDENTITY(1,1) PRIMARY KEY,
    TABLE_NAME VARCHAR(200) NOT NULL,
    DESCRIPTION VARCHAR(MAX) NULL,
    DECISION_QUERY VARCHAR(MAX) NULL,
    CREATED_TIMESTAMP DATETIME DEFAULT GETDATE(),
    UPDATED_TIMESTAMP DATETIME NULL
);

-- 18) RULE_TAGS
CREATE TABLE RULE_TAGS (
    TAG_ID INT IDENTITY(1,1) PRIMARY KEY,
    RULE_ID INT NOT NULL,
    TAG_NAME VARCHAR(100) NOT NULL
);

-- 19) DATA_VALIDATIONS
CREATE TABLE DATA_VALIDATIONS (
    VALIDATION_ID INT IDENTITY(1,1) PRIMARY KEY,
    TABLE_NAME VARCHAR(200) NOT NULL,
    COLUMN_NAME VARCHAR(200) NOT NULL,
    VALIDATION_TYPE VARCHAR(50) NOT NULL,  -- e.g. NOT NULL, RANGE, REGEX
    PARAMS VARCHAR(500) NULL,
    CREATED_TIMESTAMP DATETIME DEFAULT GETDATE()
);

-- 20) DATA_VALIDATION_LOGS
CREATE TABLE DATA_VALIDATION_LOGS (
    LOG_ID INT IDENTITY(1,1) PRIMARY KEY,
    VALIDATION_ID INT NOT NULL,
    RESULT_FLAG VARCHAR(10) NOT NULL,    -- PASS or FAIL
    DETAILS VARCHAR(MAX) NULL,
    VALIDATION_TIMESTAMP DATETIME NOT NULL,
    TABLE_NAME VARCHAR(200) NULL,
    COLUMN_NAME VARCHAR(200) NULL
);

-- 21) BRM_CUSTOM_RULE_GROUPS
CREATE TABLE BRM_CUSTOM_RULE_GROUPS (
    CUSTOM_GROUP_ID INT IDENTITY(1,1) PRIMARY KEY,
    CUSTOM_GROUP_NAME VARCHAR(200) NOT NULL,
    OWNER_BUSINESS_GROUP VARCHAR(100) NULL,
    CREATED_BY VARCHAR(100) NULL,
    CREATED_TIMESTAMP DATETIME DEFAULT GETDATE()
);

-- 22) BRM_CUSTOM_GROUP_MEMBERS
CREATE TABLE BRM_CUSTOM_GROUP_MEMBERS (
    MEMBER_ID INT IDENTITY(1,1) PRIMARY KEY,
    CUSTOM_GROUP_ID INT NOT NULL,
    RULE_ID INT NOT NULL
);

-- 23) BRM_CUSTOM_GROUP_BACKUPS
CREATE TABLE BRM_CUSTOM_GROUP_BACKUPS (
    BACKUP_ID INT IDENTITY(1,1) PRIMARY KEY,
    CUSTOM_GROUP_ID INT NOT NULL,
    BACKUP_TIMESTAMP DATETIME NOT NULL DEFAULT GETDATE(),
    BACKUP_VERSION INT NOT NULL,
    BACKUP_JSON VARCHAR(MAX) NOT NULL
);

-- 24) RULE_SNAPSHOTS
CREATE TABLE RULE_SNAPSHOTS (
    SNAPSHOT_ID INT IDENTITY(1,1) PRIMARY KEY,
    SNAPSHOT_NAME VARCHAR(200) NOT NULL,
    CREATED_BY VARCHAR(100) NOT NULL,
    CREATED_TIMESTAMP DATETIME NOT NULL DEFAULT GETDATE(),
    SNAPSHOT_JSON VARCHAR(MAX) NOT NULL
);

-- 25) BRM_DECISION_TABLE_EXEC_LOGS (if advanced usage from advanced_decision_tables)
CREATE TABLE DECISION_TABLE_EXEC_LOGS (
    EXEC_ID INT IDENTITY(1,1) PRIMARY KEY,
    DECISION_TABLE_ID INT NOT NULL,
    EXEC_TIMESTAMP DATETIME NOT NULL DEFAULT GETDATE(),
    PASS_FLAG BIT NOT NULL DEFAULT 1,
    MESSAGE VARCHAR(500) NULL,
    RECORD_COUNT INT NOT NULL DEFAULT 0,
    EXECUTION_TIME_MS INT NOT NULL DEFAULT 0,
    DRY_RUN BIT NOT NULL DEFAULT 1
);

-- 26) BRM_ACTIVITY_LOG for broader events (login, BFS, schedule triggers, etc.)
CREATE TABLE BRM_ACTIVITY_LOG (
    ACTIVITY_ID INT IDENTITY(1,1) PRIMARY KEY,
    EVENT_TYPE VARCHAR(50) NOT NULL,
    USERNAME VARCHAR(100) NOT NULL,
    TIMESTAMP DATETIME NOT NULL DEFAULT GETDATE(),
    DETAILS VARCHAR(MAX) NULL,
    RULE_ID INT NULL
);

--------------------------------------------------------------------------------
-- End of DDL for the advanced BRM tool
--------------------------------------------------------------------------------